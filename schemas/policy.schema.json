{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://company.com/schemas/network-policy.json",
  "title": "NetworkPolicy",
  "description": "Schema for network security policy definitions",
  "type": "object",
  "required": ["apiVersion", "kind", "metadata", "spec"],
  "properties": {
    "apiVersion": {
      "type": "string",
      "enum": ["netsec/v1"],
      "description": "API version for the policy schema"
    },
    "kind": {
      "type": "string",
      "enum": ["NetworkPolicy"],
      "description": "Resource type"
    },
    "metadata": {
      "type": "object",
      "required": ["name", "requestor", "ticket"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9][a-z0-9-]*[a-z0-9]$",
          "minLength": 3,
          "maxLength": 63,
          "description": "Unique policy name (lowercase, alphanumeric, hyphens)"
        },
        "requestor": {
          "type": "string",
          "format": "email",
          "description": "Email of the person requesting this policy"
        },
        "ticket": {
          "type": "string",
          "pattern": "^[A-Z]+-[0-9]+$",
          "description": "Associated ticket number (e.g., SNOW-12345)"
        },
        "environment": {
          "type": "string",
          "enum": ["production", "staging", "development"],
          "description": "Target environment"
        },
        "expiration": {
          "type": "string",
          "format": "date",
          "description": "Optional expiration date for temporary rules (YYYY-MM-DD)"
        },
        "labels": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Additional labels for categorization"
        }
      }
    },
    "spec": {
      "type": "object",
      "required": ["source", "destination", "services", "action", "targets"],
      "properties": {
        "description": {
          "type": "string",
          "maxLength": 255,
          "description": "Human-readable description of the policy"
        },
        "source": {
          "$ref": "#/definitions/endpoint",
          "description": "Source of the traffic"
        },
        "destination": {
          "$ref": "#/definitions/endpoint",
          "description": "Destination of the traffic"
        },
        "services": {
          "type": "array",
          "minItems": 1,
          "items": {
            "oneOf": [
              {
                "type": "string",
                "description": "Reference to a service defined in registry"
              },
              {
                "$ref": "#/definitions/inlineService"
              }
            ]
          },
          "description": "Services (ports/protocols) to allow"
        },
        "action": {
          "type": "string",
          "enum": ["allow", "deny"],
          "description": "Action to take on matching traffic"
        },
        "logging": {
          "type": "boolean",
          "default": true,
          "description": "Whether to log matching traffic"
        },
        "targets": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/target"
          },
          "description": "Target platforms and scopes for this policy"
        },
        "guardrails": {
          "type": "object",
          "properties": {
            "skip-review": {
              "type": "boolean",
              "default": false,
              "description": "Force human review even if within guardrails"
            },
            "justification": {
              "type": "string",
              "description": "Justification for policies outside normal guardrails"
            }
          }
        }
      }
    }
  },
  "definitions": {
    "endpoint": {
      "type": "object",
      "oneOf": [
        {
          "required": ["group"],
          "properties": {
            "group": {
              "type": "string",
              "description": "Reference to a group in the registry"
            }
          }
        },
        {
          "required": ["host"],
          "properties": {
            "host": {
              "type": "string",
              "description": "Reference to a host in the registry"
            }
          }
        },
        {
          "required": ["cidr"],
          "properties": {
            "cidr": {
              "type": "string",
              "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$",
              "description": "CIDR notation (e.g., 10.0.0.0/8)"
            }
          }
        },
        {
          "required": ["any"],
          "properties": {
            "any": {
              "type": "boolean",
              "const": true,
              "description": "Match any source/destination (use with caution)"
            }
          }
        }
      ]
    },
    "inlineService": {
      "type": "object",
      "required": ["protocol", "port"],
      "properties": {
        "protocol": {
          "type": "string",
          "enum": ["tcp", "udp", "icmp"],
          "description": "IP protocol"
        },
        "port": {
          "oneOf": [
            {
              "type": "integer",
              "minimum": 1,
              "maximum": 65535
            },
            {
              "type": "string",
              "pattern": "^[0-9]+-[0-9]+$",
              "description": "Port range (e.g., 8080-8090)"
            }
          ],
          "description": "Port number or range"
        },
        "description": {
          "type": "string",
          "description": "Description of this service"
        }
      }
    },
    "target": {
      "type": "object",
      "required": ["platform", "scope"],
      "properties": {
        "platform": {
          "type": "string",
          "enum": ["aws", "gcp", "azure", "paloalto", "fortinet", "illumio"],
          "description": "Target platform"
        },
        "scope": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "Scopes within the platform (e.g., account names, device groups)"
        }
      }
    }
  }
}
