# =============================================================================
# Auto-generated by Network Security Policy-as-Code
# Policy: allow-web-to-api
# Ticket: SNOW-12345
# Requestor: john.smith@company.com
# Scope: adom-production
# =============================================================================

# Supporting Resources

resource "fortios_firewall_address" "net_web_tier_0" {
  name    = "net-web-tier-0"
  type    = "ipmask"
  subnet  = "10.100.1.0/24"
  comment = "Network for web-tier - Managed by policy-as-code"
}


resource "fortios_firewall_address" "net_web_tier_1" {
  name    = "net-web-tier-1"
  type    = "ipmask"
  subnet  = "10.200.1.0/24"
  comment = "Network for web-tier - Managed by policy-as-code"
}


resource "fortios_firewall_address" "host_prod_web_01" {
  name    = "host-prod-web-01"
  type    = "ipmask"
  subnet  = "10.100.1.10/32"
  comment = "Host prod-web-01 - Managed by policy-as-code"
}


resource "fortios_firewall_address" "fqdn_prod_web_01" {
  name    = "fqdn-prod-web-01"
  type    = "fqdn"
  fqdn    = "prod-web-01.internal.company.com"
  comment = "FQDN for prod-web-01 - Managed by policy-as-code"
}


resource "fortios_firewall_address" "host_prod_web_02" {
  name    = "host-prod-web-02"
  type    = "ipmask"
  subnet  = "10.100.1.11/32"
  comment = "Host prod-web-02 - Managed by policy-as-code"
}


resource "fortios_firewall_address" "fqdn_prod_web_02" {
  name    = "fqdn-prod-web-02"
  type    = "fqdn"
  fqdn    = "prod-web-02.internal.company.com"
  comment = "FQDN for prod-web-02 - Managed by policy-as-code"
}


resource "fortios_firewall_addrgrp" "grp_web_tier" {
  name    = "grp-web-tier"
  comment = "Address Group: web-tier - Managed by policy-as-code"

  member {
    name = fortios_firewall_address.net_web_tier_0.name
  }

  member {
    name = fortios_firewall_address.net_web_tier_1.name
  }

  member {
    name = fortios_firewall_address.host_prod_web_01.name
  }

  member {
    name = fortios_firewall_address.fqdn_prod_web_01.name
  }

  member {
    name = fortios_firewall_address.host_prod_web_02.name
  }

  member {
    name = fortios_firewall_address.fqdn_prod_web_02.name
  }
}


resource "fortios_firewall_address" "net_api_tier_0" {
  name    = "net-api-tier-0"
  type    = "ipmask"
  subnet  = "10.100.2.0/24"
  comment = "Network for api-tier - Managed by policy-as-code"
}


resource "fortios_firewall_address" "net_api_tier_1" {
  name    = "net-api-tier-1"
  type    = "ipmask"
  subnet  = "10.200.2.0/24"
  comment = "Network for api-tier - Managed by policy-as-code"
}


resource "fortios_firewall_address" "host_prod_api_01" {
  name    = "host-prod-api-01"
  type    = "ipmask"
  subnet  = "10.100.2.10/32"
  comment = "Host prod-api-01 - Managed by policy-as-code"
}


resource "fortios_firewall_address" "fqdn_prod_api_01" {
  name    = "fqdn-prod-api-01"
  type    = "fqdn"
  fqdn    = "prod-api-01.internal.company.com"
  comment = "FQDN for prod-api-01 - Managed by policy-as-code"
}


resource "fortios_firewall_addrgrp" "grp_api_tier" {
  name    = "grp-api-tier"
  comment = "Address Group: api-tier - Managed by policy-as-code"

  member {
    name = fortios_firewall_address.net_api_tier_0.name
  }

  member {
    name = fortios_firewall_address.net_api_tier_1.name
  }

  member {
    name = fortios_firewall_address.host_prod_api_01.name
  }

  member {
    name = fortios_firewall_address.fqdn_prod_api_01.name
  }
}

# Policy Resources

resource "fortios_firewall_policy" "allow_web_to_api" {
  name     = "allow-web-to-api"
  action   = "accept"
  schedule = "always"
  
  srcintf {
    name = "any"
  }
  
  dstintf {
    name = "any"
  }
  
  srcaddr {
    name = "grp-web-tier"
  }
  
  dstaddr {
    name = "grp-api-tier"
  }
  

  service {
    name = "HTTPS"
  }
  
  logtraffic = "all"
  comments   = "Allow web tier to communicate with API tier on HTTPS - SNOW-12345"
  
  nat = "disable"
}
