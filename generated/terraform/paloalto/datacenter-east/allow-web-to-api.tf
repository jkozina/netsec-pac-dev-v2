# =============================================================================
# Auto-generated by Network Security Policy-as-Code
# Policy: allow-web-to-api
# Ticket: SNOW-12345
# Requestor: john.smith@company.com
# Scope: datacenter-east
# =============================================================================

# Supporting Resources

resource "panos_panorama_dynamic_address_group" "dag_web_tier" {
  device_group = "datacenter-east"
  name         = "dag-web-tier"
  description  = "Dynamic portion of web-tier - Managed by policy-as-code"
  match        = "'tier.web' and 'env.production'"
  
  tags = ["policy-as-code", "dynamic"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_object" "net_web_tier_0" {
  device_group = "datacenter-east"
  name         = "net-web-tier-0"
  description  = "Network for web-tier - Managed by policy-as-code"
  value        = "10.100.1.0/24"
  
  tags = ["policy-as-code"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_object" "net_web_tier_1" {
  device_group = "datacenter-east"
  name         = "net-web-tier-1"
  description  = "Network for web-tier - Managed by policy-as-code"
  value        = "10.200.1.0/24"
  
  tags = ["policy-as-code"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_object" "host_prod_web_01" {
  device_group = "datacenter-east"
  name         = "host-prod-web-01"
  description  = "Host prod-web-01 - Managed by policy-as-code"
  value        = "10.100.1.10"
  
  tags = ["policy-as-code"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_object" "host_prod_web_02" {
  device_group = "datacenter-east"
  name         = "host-prod-web-02"
  description  = "Host prod-web-02 - Managed by policy-as-code"
  value        = "10.100.1.11"
  
  tags = ["policy-as-code"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_group" "grp_web_tier_static" {
  device_group = "datacenter-east"
  name         = "grp-web-tier-static"
  description  = "Static portion of web-tier - Managed by policy-as-code"
  
  static_addresses = [
    panos_panorama_address_object.net_web_tier_0.name,
    panos_panorama_address_object.net_web_tier_1.name,
    panos_panorama_address_object.host_prod_web_01.name,
    panos_panorama_address_object.host_prod_web_02.name
  ]
  
  tags = ["policy-as-code", "static"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_group" "grp_web_tier" {
  device_group = "datacenter-east"
  name         = "grp-web-tier"
  description  = "Combined group: web-tier (DAG + Static) - Managed by policy-as-code"
  
  static_addresses = [
    panos_panorama_dynamic_address_group.dag_web_tier.name,
    panos_panorama_address_group.grp_web_tier_static.name,
  ]
  
  tags = ["policy-as-code", "combined"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_dynamic_address_group" "dag_api_tier" {
  device_group = "datacenter-east"
  name         = "dag-api-tier"
  description  = "Dynamic portion of api-tier - Managed by policy-as-code"
  match        = "'tier.api' and 'env.production'"
  
  tags = ["policy-as-code", "dynamic"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_object" "net_api_tier_0" {
  device_group = "datacenter-east"
  name         = "net-api-tier-0"
  description  = "Network for api-tier - Managed by policy-as-code"
  value        = "10.100.2.0/24"
  
  tags = ["policy-as-code"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_object" "net_api_tier_1" {
  device_group = "datacenter-east"
  name         = "net-api-tier-1"
  description  = "Network for api-tier - Managed by policy-as-code"
  value        = "10.200.2.0/24"
  
  tags = ["policy-as-code"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_object" "host_prod_api_01" {
  device_group = "datacenter-east"
  name         = "host-prod-api-01"
  description  = "Host prod-api-01 - Managed by policy-as-code"
  value        = "10.100.2.10"
  
  tags = ["policy-as-code"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_group" "grp_api_tier_static" {
  device_group = "datacenter-east"
  name         = "grp-api-tier-static"
  description  = "Static portion of api-tier - Managed by policy-as-code"
  
  static_addresses = [
    panos_panorama_address_object.net_api_tier_0.name,
    panos_panorama_address_object.net_api_tier_1.name,
    panos_panorama_address_object.host_prod_api_01.name
  ]
  
  tags = ["policy-as-code", "static"]
  
  lifecycle {
    create_before_destroy = true
  }
}


resource "panos_panorama_address_group" "grp_api_tier" {
  device_group = "datacenter-east"
  name         = "grp-api-tier"
  description  = "Combined group: api-tier (DAG + Static) - Managed by policy-as-code"
  
  static_addresses = [
    panos_panorama_dynamic_address_group.dag_api_tier.name,
    panos_panorama_address_group.grp_api_tier_static.name,
  ]
  
  tags = ["policy-as-code", "combined"]
  
  lifecycle {
    create_before_destroy = true
  }
}

# Policy Resources

resource "panos_panorama_security_policy" "allow_web_to_api" {
  device_group = "datacenter-east"
  
  rule {
    name                  = "allow-web-to-api"
    description           = "Allow web tier to communicate with API tier on HTTPS"
    source_zones          = ["any"]
    source_addresses      = ["grp-web-tier"]
    source_users          = ["any"]
    destination_zones     = ["any"]
    destination_addresses = ["grp-api-tier"]
    applications          = ["web-browsing", "ssl"]
    services              = ["application-default"]
    categories            = ["any"]
    action                = "allow"
    log_setting = "default-logging"
    
    tags = ["policy-as-code", "SNOW-12345"]
  }
  
  lifecycle {
    create_before_destroy = true
  }
}
